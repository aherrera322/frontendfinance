<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Management - Zimple Travel</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: '#117372'
					}
				}
			}
		}
	</script>
</head>
<body class="bg-gray-50">
	<nav class="bg-white shadow">
		<div class="max-w-6xl mx-auto px-4">
			<div class="flex justify-between h-16">
				<div class="flex items-center">
					<img src="../../public/images/zimple-logo.png" alt="Zimple Travel" class="h-8">
					<div class="ml-4 flex space-x-4">
						<a href="../clients/index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">Clients</a>
						<a href="../partners/index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">Partners</a>
						<a href="./" class="bg-primary text-white px-3 py-2 rounded-md text-sm font-medium">Users</a>
					</div>
				</div>
				<div class="flex items-center">
					<a href="../../index.html" class="text-gray-700 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">Home</a>
				</div>
			</div>
		</div>
	</nav>

	<section class="max-w-6xl mx-auto px-4 py-6">
		<div class="flex items-center justify-between mb-4">
			<h1 class="text-2xl font-semibold">Users</h1>
			<button id="openCreate" class="bg-primary text-white px-3 py-2 rounded">Add User</button>
		</div>

		<div class="flex items-center gap-2 mb-4">
			<input id="search" type="text" placeholder="Search by name, email, company" class="border rounded px-3 py-2 w-full">
			<button id="doSearch" class="border px-3 py-2 rounded">Search</button>
		</div>

		<div class="bg-white rounded shadow">
			<table class="w-full text-sm">
				<thead class="bg-gray-100">
					<tr>
						<th class="text-left p-2">Name</th>
						<th class="text-left p-2">Email</th>
						<th class="text-left p-2">Department</th>
						<th class="text-left p-2">Phone</th>
						<th class="text-left p-2">Company</th>
						<th class="text-left p-2">Status</th>
						<th class="text-left p-2">Verified</th>
						<th class="text-left p-2">Newsletter</th>
						<th class="text-left p-2">Last Login</th>
						<th class="text-right p-2">Actions</th>
					</tr>
				</thead>
				<tbody id="rows"></tbody>
			</table>
		</div>

		<div id="pagination" class="flex justify-between items-center mt-3 text-sm"></div>
	</section>

	<!-- Modal -->
	<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40">
		<div class="bg-white rounded shadow w-full max-w-xl">
			<div class="p-3 border-b flex items-center justify-between">
				<h2 id="modalTitle" class="font-semibold">Create User</h2>
				<button id="closeModal" class="text-gray-500">✕</button>
			</div>
			<div class="p-4 grid grid-cols-2 gap-3 text-sm">
				<label>
					<span class="block mb-1">First Name *</span>
					<input id="f_first_name" class="border rounded px-2 py-1 w-full">
				</label>
				<label>
					<span class="block mb-1">Last Name *</span>
					<input id="f_last_name" class="border rounded px-2 py-1 w-full">
				</label>
				<label class="col-span-2">
					<span class="block mb-1">Email *</span>
					<input id="f_email" type="email" class="border rounded px-2 py-1 w-full">
				</label>
				<label>
					<span class="block mb-1">Phone</span>
					<input id="f_phone" class="border rounded px-2 py-1 w-full">
				</label>
				<label>
					<span class="block mb-1">Company</span>
					<input id="f_company" class="border rounded px-2 py-1 w-full">
				</label>
				<label class="col-span-2">
					<span class="block mb-1">Department/Role *</span>
					<select id="f_department" class="border rounded px-2 py-1 w-full">
						<option value="">Select Department</option>
					</select>
					<small class="text-gray-500" id="roleDescription"></small>
				</label>
				<label class="col-span-2">
					<span class="block mb-1">Password <span id="passwordRequired">*</span></span>
					<input id="f_password" type="password" class="border rounded px-2 py-1 w-full">
					<small class="text-gray-500">Leave blank to keep current password when editing</small>
				</label>
				<label class="col-span-2">
					<input id="f_newsletter" type="checkbox" class="mr-2">
					<span>Newsletter Subscribed</span>
				</label>
				<label class="col-span-2">
					<input id="f_email_verified" type="checkbox" class="mr-2">
					<span>Email Verified</span>
				</label>
				<label class="col-span-2">
					<input id="f_is_active" type="checkbox" class="mr-2" checked>
					<span>Active Account</span>
				</label>
			</div>
			<div class="p-3 border-t flex justify-end gap-2">
				<button id="save" class="bg-primary text-white px-3 py-1 rounded text-sm">Save</button>
				<button id="cancel" class="border px-3 py-1 rounded text-sm">Cancel</button>
			</div>
		</div>
	</div>

	<script>
		const apiBase = './api.php';
		let editId = null;
		let currentPage = 1;
		let availableRoles = {};
		let currentUserPermissions = [];

		function qs(selector) {
			return document.querySelector(selector);
		}

		function show(element) {
			element.classList.remove('hidden');
		}

		function hide(element) {
			element.classList.add('hidden');
		}

		function formatDate(dateString) {
			if (!dateString) return '-';
			const date = new Date(dateString);
			return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
		}

		function formatBoolean(value) {
			return value ? '✓' : '✗';
		}

		async function load() {
			try {
				const search = qs('#search').value;
				const params = new URLSearchParams({
					page: currentPage,
					page_size: 20
				});
				if (search) params.append('search', search);

				const response = await fetch(`${apiBase}?${params}`);
				const result = await response.json();

				if (!result.success) {
					alert('Failed to load users: ' + result.message);
					return;
				}

				// Store roles and permissions
				availableRoles = result.roles || {};
				currentUserPermissions = result.current_user_permissions || [];

				// Populate department dropdown
				populateDepartmentDropdown();

				const tbody = qs('#rows');
				tbody.innerHTML = '';

				result.data.forEach(user => {
					const row = document.createElement('tr');
					row.className = 'border-t hover:bg-gray-50';
					row.innerHTML = `
						<td class="p-2">${user.first_name} ${user.last_name}</td>
						<td class="p-2">${user.email}</td>
						<td class="p-2">
							<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
								${user.department_display || user.department || 'Unknown'}
							</span>
						</td>
						<td class="p-2">${user.phone || '-'}</td>
						<td class="p-2">${user.company || '-'}</td>
						<td class="p-2">
							<span class="px-2 py-1 rounded text-xs ${user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
								${user.is_active ? 'Active' : 'Inactive'}
							</span>
						</td>
						<td class="p-2">${formatBoolean(user.email_verified)}</td>
						<td class="p-2">${formatBoolean(user.newsletter_subscribed)}</td>
						<td class="p-2">${formatDate(user.last_login)}</td>
						<td class="p-2 text-right">
							<button onclick="edit(${user.id})" class="text-blue-600 hover:text-blue-800 mr-2">Edit</button>
							<button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800">Delete</button>
						</td>
					`;
					tbody.appendChild(row);
				});

				// Pagination
				const pagination = qs('#pagination');
				const total = result.pagination.total;
				const pageSize = result.pagination.page_size;
				const totalPages = Math.ceil(total / pageSize);

				if (totalPages > 1) {
					pagination.innerHTML = `
						<div>
							Showing ${((currentPage - 1) * pageSize) + 1} to ${Math.min(currentPage * pageSize, total)} of ${total} users
						</div>
						<div class="flex gap-1">
							${currentPage > 1 ? `<button onclick="goToPage(${currentPage - 1})" class="border px-2 py-1 rounded">Previous</button>` : ''}
							<span class="border px-2 py-1 rounded">Page ${currentPage} of ${totalPages}</span>
							${currentPage < totalPages ? `<button onclick="goToPage(${currentPage + 1})" class="border px-2 py-1 rounded">Next</button>` : ''}
						</div>
					`;
				} else {
					pagination.innerHTML = `<div>Showing ${total} users</div>`;
				}

			} catch (error) {
				console.error('Error loading users:', error);
				alert('Failed to load users');
			}
		}

		function goToPage(page) {
			currentPage = page;
			load();
		}

		function clearForm() {
			qs('#f_first_name').value = '';
			qs('#f_last_name').value = '';
			qs('#f_email').value = '';
			qs('#f_phone').value = '';
			qs('#f_company').value = '';
			qs('#f_department').value = '';
			qs('#f_password').value = '';
			qs('#f_newsletter').checked = false;
			qs('#f_email_verified').checked = false;
			qs('#f_is_active').checked = true;
			qs('#passwordRequired').textContent = '*';
			qs('#roleDescription').textContent = '';
		}

		function populateDepartmentDropdown() {
			const select = qs('#f_department');
			select.innerHTML = '<option value="">Select Department</option>';
			
			Object.entries(availableRoles).forEach(([value, display]) => {
				const option = document.createElement('option');
				option.value = value;
				option.textContent = display;
				select.appendChild(option);
			});
		}

		function updateRoleDescription() {
			const department = qs('#f_department').value;
			const descriptions = {
				'site_administrator': 'Full system access with ability to manage all users, data, and system settings',
				'agent_aerovision': 'Can view and edit Aerovision data, manage clients, and view reports',
				'agent_zimple': 'Can view and edit Zimple data, manage clients, and view reports',
				'accounting_aerovision': 'Can view Aerovision data, manage accounting records, and generate financial reports',
				'accounting_zimple': 'Can view Zimple data, manage accounting records, and generate financial reports',
				'accounting_manager': 'Can view all data, manage accounting records, commissions, and generate financial reports'
			};
			
			qs('#roleDescription').textContent = descriptions[department] || '';
		}

		function edit(id) {
			editId = id;
			qs('#modalTitle').textContent = 'Edit User';
			qs('#passwordRequired').textContent = '';
			
			// Load user data
			fetch(`${apiBase}?search=&page=1&page_size=1000`)
				.then(response => response.json())
				.then(result => {
					if (result.success) {
						const user = result.data.find(u => u.id === id);
						if (user) {
							qs('#f_first_name').value = user.first_name;
							qs('#f_last_name').value = user.last_name;
							qs('#f_email').value = user.email;
							qs('#f_phone').value = user.phone || '';
							qs('#f_company').value = user.company || '';
							qs('#f_department').value = user.department || '';
							qs('#f_password').value = '';
							qs('#f_newsletter').checked = user.newsletter_subscribed;
							qs('#f_email_verified').checked = user.email_verified;
							qs('#f_is_active').checked = user.is_active;
							updateRoleDescription();
							show(qs('#modal'));
						}
					}
				});
		}

		async function deleteUser(id) {
			if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
				return;
			}

			try {
				const response = await fetch(apiBase, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'delete', id: id })
				});
				const result = await response.json();

				if (result.success) {
					load();
				} else {
					alert('Failed to delete user: ' + result.message);
				}
			} catch (error) {
				console.error('Error deleting user:', error);
				alert('Failed to delete user');
			}
		}

		// Event listeners
		qs('#openCreate').addEventListener('click', () => {
			editId = null;
			qs('#modalTitle').textContent = 'Create User';
			qs('#passwordRequired').textContent = '*';
			clearForm();
			show(qs('#modal'));
		});

		qs('#closeModal').addEventListener('click', () => {
			hide(qs('#modal'));
		});

		qs('#cancel').addEventListener('click', () => {
			hide(qs('#modal'));
		});

		qs('#doSearch').addEventListener('click', () => {
			currentPage = 1;
			load();
		});

		qs('#search').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				currentPage = 1;
				load();
			}
		});

		qs('#save').addEventListener('click', async () => {
			const payload = {
				action: editId ? 'update' : 'create',
				id: editId ? Number(editId) : undefined,
				first_name: qs('#f_first_name').value.trim(),
				last_name: qs('#f_last_name').value.trim(),
				email: qs('#f_email').value.trim(),
				phone: qs('#f_phone').value.trim() || null,
				company: qs('#f_company').value.trim() || null,
				department: qs('#f_department').value || 'agent_zimple',
				password: qs('#f_password').value || null,
				newsletter_subscribed: qs('#f_newsletter').checked,
				email_verified: qs('#f_email_verified').checked,
				is_active: qs('#f_is_active').checked
			};

			try {
				const response = await fetch(apiBase, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				});
				const result = await response.json();

				if (result.success) {
					hide(qs('#modal'));
					load();
				} else {
					alert('Failed to save user: ' + result.message);
				}
			} catch (error) {
				console.error('Error saving user:', error);
				alert('Failed to save user');
			}
		});

		// Close modal when clicking outside
		qs('#modal').addEventListener('click', (e) => {
			if (e.target === qs('#modal')) {
				hide(qs('#modal'));
			}
		});

		// Event listeners for department dropdown
		qs('#f_department').addEventListener('change', updateRoleDescription);

		// Initial load
		load();
	</script>
</body>
</html>
